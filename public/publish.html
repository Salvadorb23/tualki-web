<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tualki - Publicar Producto</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #F4F4F4; margin: 0; padding: 20px; }
    h2 { color: #1E3A8A; }
    input, button, textarea, select { display: block; margin: 10px 0; padding: 10px; width: 200px; }
    button { background-color: #FF6B35; color: #FFFFFF; border: none; cursor: pointer; }
    button:hover { background-color: #E55A2D; }
  </style>
</head>
<body>
  <section>
    <h2>Publicar Producto</h2>
    <input type="text" id="product-name" placeholder="Nombre del producto" />
    <textarea id="product-description" placeholder="Descripción"></textarea>
    <select id="product-category">
      <option value="">Selecciona una categoría</option>
      <option value="Deportes">Deportes</option>
      <option value="Electrónica">Electrónica</option>
      <option value="Maquinaria">Maquinaria</option>
      <option value="Hogar">Hogar</option>
      <option value="Eventos">Eventos</option>
      <option value="Moda">Moda</option>
      <option value="Otros">Otros</option>
    </select>
    <input type="number" id="price-per-day" placeholder="Precio por día (COP)" step="0.01" />
    <input type="number" id="sale-price" placeholder="Precio de venta (opcional, COP)" step="0.01" />
    <input type="file" id="product-image" accept="image/*" />
    <button id="publish-btn">Publicar</button>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = Supabase.createClient(
      '[pega tu SUPABASE_URL aquí]',
      '[pega tu SUPABASE_ANON_KEY aquí]'
    );
    window.supabase = supabase;

    document.getElementById('publish-btn').addEventListener('click', async () => {
      const name = document.getElementById('product-name').value;
      const description = document.getElementById('product-description').value;
      const category = document.getElementById('product-category').value;
      const pricePerDay = parseFloat(document.getElementById('price-per-day').value);
      const salePrice = document.getElementById('sale-price').value ? parseFloat(document.getElementById('sale-price').value) : null;
      const file = document.getElementById('product-image').files[0];

      if (!name || !description || !category || !pricePerDay || !file) {
        alert("Por favor, completa todos los campos obligatorios.");
        return;
      }

      const { data: userData, error: userError } = await supabase.auth.getUser();
      if (userError || !userData.user) {
        alert("Debes iniciar sesión para publicar.");
        return;
      }

      const fileName = `${userData.user.id}/${Date.now()}_${file.name}`;
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('tualki-images')
        .upload(fileName, file);

      if (uploadError) {
        alert("Error al subir la imagen: " + uploadError.message);
        return;
      }

      const { data: urlData } = supabase.storage
        .from('tualki-images')
        .getPublicUrl(fileName);

      const { data, error } = await supabase
        .from('products')
        .insert([
          {
            user_id: userData.user.id,
            name,
            description,
            category,
            price_per_day: pricePerDay,
            sale_price: salePrice,
            image_url: urlData.publicUrl
          }
        ]);

      if (error) {
        alert("Error al publicar: " + error.message);
      } else {
        alert("Producto publicado con éxito");
        console.log("Producto:", data);
      }
    });
  </script>
</body>
</html>