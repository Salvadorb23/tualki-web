<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Tualki</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.wompi.co/widget/v2/widget.js" defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #ff6200;
            margin-bottom: 20px;
        }
        p {
            margin-bottom: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="action-title"></h2>
        <p><strong>Producto:</strong> <span id="product-name"></span></p>
        <p><span id="product-description"></span></p>
        <p><strong>Precio:</strong> <span id="product-price"></span></p>
        <button id="pay-button" disabled>Pagar</button>
    </div>

    <script>
        // Fetch environment variables from Vercel (client-side workaround)
        async function fetchEnvVariables() {
            try {
                const response = await fetch('/api/env');
                const env = await response.json();
                return {
                    publicKey: env.WOMPI_PUBLIC_KEY || 'pub_test_EtTODv4mMOMQj2q8Xz3LzXSjtPWRnPeJ',
                    integrityKey: env.WOMPI_INTEGRITY_KEY || 'test_integrity_Eeq1kYx2Lh6tiBzqN8FELuosI2iWhyGq'
                };
            } catch (error) {
                console.error('Error al cargar variables de entorno:', error);
                return {
                    publicKey: 'pub_test_EtTODv4mMOMQj2q8Xz3LzXSjtPWRnPeJ',
                    integrityKey: 'test_integrity_Eeq1kYx2Lh6tiBzqN8FELuosI2iWhyGq'
                };
            }
        }

        // Función para esperar a que Wompi esté cargado
        function waitForWompi() {
            return new Promise((resolve, reject) => {
                const maxAttempts = 20;
                let attempts = 0;
                const interval = setInterval(() => {
                    if (window.WompiCheckout) {
                        clearInterval(interval);
                        console.log('WompiCheckout está disponible');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        console.error('No se pudo cargar WompiCheckout después de', maxAttempts, 'intentos');
                        reject(new Error('No se pudo cargar el script de Wompi'));
                    }
                    attempts++;
                }, 500);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Página cargada, intentando cargar el script de Wompi...');

            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const description = urlParams.get('description');
            const pricePerDay = parseFloat(urlParams.get('price_per_day'));
            const salePrice = urlParams.get('sale_price') ? parseFloat(urlParams.get('sale_price')) : null;
            const action = urlParams.get('action');
            const productId = urlParams.get('product_id');

            const actionTitle = document.getElementById('action-title');
            const productName = document.getElementById('product-name');
            const productDescription = document.getElementById('product-description');
            const productPrice = document.getElementById('product-price');
            const payButton = document.getElementById('pay-button');

            productName.textContent = name || 'Producto desconocido';
            productDescription.textContent = description || 'Sin descripción';

            let displayPrice;
            if (action === 'rent') {
                actionTitle.textContent = 'Alquilar Producto';
                displayPrice = pricePerDay;
            } else if (action === 'buy') {
                actionTitle.textContent = 'Comprar Producto';
                displayPrice = salePrice;
            } else {
                actionTitle.textContent = 'Error';
                displayPrice = 0;
                productPrice.textContent = 'Precio no disponible';
                console.error('Acción no válida:', action);
                return;
            }

            productPrice.textContent = displayPrice.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });

            // Cargar las variables de entorno
            const { publicKey, integrityKey } = await fetchEnvVariables();
            console.log('Claves cargadas:', { publicKey, integrityKey });

            try {
                // Esperar a que Wompi esté cargado
                await waitForWompi();
                console.log('Wompi cargado correctamente');
                payButton.disabled = false;
            } catch (error) {
                console.error(error.message);
                alert('Error: No se pudo cargar el sistema de pago. Intenta de nuevo más tarde.');
                return;
            }

            payButton.addEventListener('click', async () => {
                console.log('Iniciando pago - Parámetros:', { displayPrice });

                const amount = displayPrice;
                const reference = 'TUALKI-' + Date.now();
                const currency = 'COP';
                const redirectUrl = 'https://tualki-web.vercel.app/index.html';

                console.log('Configurando Wompi con:', { amount, reference, currency, publicKey, redirectUrl });

                const amountInCents = parseInt(amount) * 100;
                const stringToSign = `${reference}${amountInCents}${currency}${integrityKey}`;
                const encoder = new TextEncoder();
                const data = encoder.encode(stringToSign);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const signature = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                console.log('Firma generada:', signature);

                const checkout = new WompiCheckout({
                    currency: currency,
                    amountInCents: amountInCents,
                    reference: reference,
                    publicKey: publicKey,
                    redirectUrl: redirectUrl,
                    signature: {
                        integrity: signature
                    }
                });

                console.log('Abriendo checkout de Wompi...');
                checkout.open(async (result) => {
                    console.log('Resultado de Wompi:', result);

                    if (result.status === 'APPROVED') {
                        alert('¡Pago exitoso!');
                        console.log('Pago aprobado, guardando transacción...');

                        const supabase = window.supabase.createClient(
                            'https://vrvwmlromomnynckppqz.supabase.co',
                            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydndtbHJvbW9tbnluY2twcHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3MzQ2NjksImV4cCI6MjA2MTMxMDY2OX0.F1PJQG59heZWX2M9lHTQNRVr63Sijk-xVjOH5X8D7lE'
                        );

                        const { data: session } = await supabase.auth.getSession();
                        if (session.session) {
                            const { error } = await supabase.from('transactions').insert({
                                buyer_id: session.session.user.id,
                                product_id: productId,
                                amount: amount,
                                type: action,
                                status: 'completed',
                                reference: reference,
                                created_at: new Date().toISOString()
                            });

                            if (error) {
                                console.error('Error al guardar la transacción:', error.message);
                                alert('Pago exitoso, pero hubo un error al registrar la transacción: ' + error.message);
                            } else {
                                console.log('Transacción registrada con éxito');
                                window.location.href = redirectUrl;
                            }
                        }
                    } else {
                        const errorMessage = result.status ? `Error en el pago: ${result.status}` : 'Error en el pago: Desconocido';
                        console.error(errorMessage);
                        alert(errorMessage);
                    }
                });
            });
        });
    </script>
</body>
</html>
