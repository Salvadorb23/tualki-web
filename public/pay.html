<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Tualki</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.wompi.co/widget.js" defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #ff6200;
            margin-bottom: 20px;
        }
        p {
            margin-bottom: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="action-title"></h2>
        <p><strong>Producto:</strong> <span id="product-name"></span></p>
        <p><span id="product-description"></span></p>
        <p><strong>Precio:</strong> <span id="product-price"></span></p>
        <button id="pay-button">Pagar</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Página cargada, intentando cargar el script de Wompi...');

            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const description = urlParams.get('description');
            const pricePerDay = parseFloat(urlParams.get('price_per_day'));
            const salePrice = urlParams.get('sale_price') ? parseFloat(urlParams.get('sale_price')) : null;
            const action = urlParams.get('action');
            const productId = urlParams.get('product_id');

            const actionTitle = document.getElementById('action-title');
            const productName = document.getElementById('product-name');
            const productDescription = document.getElementById('product-description');
            const productPrice = document.getElementById('product-price');
            const payButton = document.getElementById('pay-button');

            productName.textContent = name || 'Producto desconocido';
            productDescription.textContent = description || 'Sin descripción';

            let displayPrice;
            if (action === 'rent') {
                actionTitle.textContent = 'Alquilar Producto';
                displayPrice = pricePerDay;
            } else if (action === 'buy') {
                actionTitle.textContent = 'Comprar Producto';
                displayPrice = salePrice;
            } else {
                actionTitle.textContent = 'Error';
                displayPrice = 0;
                productPrice.textContent = 'Precio no disponible';
                console.error('Acción no válida:', action);
                return;
            }

            productPrice.textContent = displayPrice.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });

            payButton.addEventListener('click', async () => {
                console.log('Iniciando pago - Parámetros:', { displayPrice });

                // Verificar si Wompi está disponible
                if (!window.Wompi) {
                    console.error('Wompi no está definido');
                    alert('Error: El sistema de pago no está disponible. Intenta de nuevo más tarde.');
                    return;
                }

                const amount = displayPrice;
                const reference = 'TUALKI-' + Date.now();
                const currency = 'COP';
                const publicKey = 'pub_test_EtTODv4mMOMQj2q8Xz3LzXSjtPWRnPeJ';
                const integrityKey = 'test_integrity_Eeq1kYx2Lh6tiBzqN8FELuosI2iWhyGq';
                const redirectUrl = 'https://tualki-web.vercel.app/index.html';

                console.log('Configurando Wompi con:', { amount, reference, currency, publicKey, redirectUrl });

                const amountInCents = parseInt(amount) * 100;
                const stringToSign = `${reference}${amountInCents}${currency}${integrityKey}`;
                const encoder = new TextEncoder();
                const data = encoder.encode(stringToSign);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const signature = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                console.log('Firma generada:', signature);

                window.Wompi.setPublicKey(publicKey);
                const checkout = window.Wompi.checkout({
                    currency: currency,
                    amountInCents: amountInCents,
                    reference: reference,
                    redirectUrl: redirectUrl,
                    signature: {
                        integrity: signature
                    }
                });

                console.log('Abriendo checkout de Wompi...');
                checkout.open(function(result) {
                    console.log('Resultado de Wompi:', result);

                    if (result && result.status === 'APPROVED') {
                        alert('¡Pago exitoso!');
                        console.log('Pago aprobado, guardando transacción...');

                        const supabase = window.supabase.createClient(
                            'https://vrvwmlromomnynckppqz.supabase.co',
                            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydndtbHJvbW9tbnluY2twcHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3MzQ2NjksImV4cCI6MjA2MTMxMDY2OX0.F1PJQG59heZWX2M9lHTQNRVr63Sijk-xVjOH5X8D7lE'
                        );

                        supabase.auth.getSession().then(({ data: session }) => {
                            if (session.session) {
                                supabase.from('transactions').insert({
                                    buyer_id: session.session.user.id,
                                    product_id: productId,
                                    amount: amount,
                                    type: action,
                                    status: 'completed',
                                    reference: reference,
                                    created_at: new Date().toISOString()
                                }).then(({ error }) => {
                                    if (error) {
                                        console.error('Error al guardar la transacción:', error.message);
                                        alert('Pago exitoso, pero hubo un error al registrar la transacción: ' + error.message);
                                    } else {
                                        console.log('Transacción registrada con éxito');
                                        window.location.href = redirectUrl;
                                    }
                                });
                            }
                        });
                    } else {
                        const errorMessage = result?.status ? `Error en el pago: ${result.status}` : 'Error en el pago: Desconocido';
                        console.error(errorMessage);
                        alert(errorMessage);
                    }
                }, function(error) {
                    console.error('Error en el checkout:', error);
                    alert('Error al procesar el pago: ' + error.message);
                });
            });
        });
    </script>
</body>
</html>
