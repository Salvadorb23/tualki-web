<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Tualki</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #ff6200;
            margin-bottom: 20px;
        }
        p {
            margin-bottom: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="action-title"></h2>
        <p><strong>Producto:</strong> <span id="product-name"></span></p>
        <p><span id="product-description"></span></p>
        <p><strong>Precio:</strong> <span id="product-price"></span></p>
        <button id="pay-button" disabled>Pagar</button>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://vrvwmlromomnynckppqz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydndtbHJvbW9tbnluY2twcHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3MzQ2NjksImV4cCI6MjA2MTMxMDY2OX0.F1PJQG59heZWX2M9lHTQNRVr63Sijk-xVjOH5X8D7lE'
        );

        const publicKey = 'pub_test_EtTODv4mMOMQj2q8Xz3LzXSjtPWRnPeJ';
        const integrityKey = 'test_integrity_Eeq1kYx2Lh6tiBzqN8FELuosI2iWhyGq';

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Página cargada, configurando pago...');

            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const description = urlParams.get('description');
            const pricePerDay = parseFloat(urlParams.get('price_per_day'));
            const salePrice = urlParams.get('sale_price') ? parseFloat(urlParams.get('sale_price')) : null;
            const action = urlParams.get('action');
            const productId = urlParams.get('product_id');

            const actionTitle = document.getElementById('action-title');
            const productName = document.getElementById('product-name');
            const productDescription = document.getElementById('product-description');
            const productPrice = document.getElementById('product-price');
            const payButton = document.getElementById('pay-button');

            productName.textContent = name || 'Producto desconocido';
            productDescription.textContent = description || 'Sin descripción';

            let displayPrice;
            if (action === 'rent') {
                actionTitle.textContent = 'Alquilar Producto';
                displayPrice = pricePerDay;
            } else if (action === 'buy') {
                actionTitle.textContent = 'Comprar Producto';
                displayPrice = salePrice;
            } else {
                actionTitle.textContent = 'Error';
                displayPrice = 0;
                productPrice.textContent = 'Precio no disponible';
                console.error('Acción no válida:', action);
                return;
            }

            productPrice.textContent = displayPrice.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
            payButton.disabled = false;

            payButton.addEventListener('click', async () => {
                console.log('Iniciando pago con enlace de Wompi...');

                const amount = parseFloat(displayPrice);
                const amountInCents = Math.floor(amount * 100);
                const reference = 'TUALKI-' + Date.now();
                const redirectUrl = 'https://tualki-web.vercel.app/index.html';
                const currency = 'COP';

                console.log('Valores para el enlace de pago:', { amount, amountInCents, reference, currency, redirectUrl });

                // Registrar la transacción en Supabase antes de redirigir
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !sessionData.session) {
                    console.error('Error al obtener sesión:', sessionError?.message);
                    alert('Debes iniciar sesión para realizar un pago.');
                    return;
                }

                const { error: transactionError } = await supabase.from('transactions').insert({
                    buyer_id: sessionData.session.user.id,
                    product_id: productId,
                    amount: amount,
                    type: action,
                    status: 'pending',
                    reference: reference,
                    created_at: new Date().toISOString()
                });

                if (transactionError) {
                    console.error('Error al registrar la transacción:', transactionError.message);
                    alert('Error al registrar la transacción: ' + transactionError.message);
                    return;
                }

                const stringToSign = `${reference}${amountInCents}${currency}${integrityKey}`;
                const encoder = new TextEncoder();
                const data = encoder.encode(stringToSign);
                crypto.subtle.digest('SHA-256', data).then(hashBuffer => {
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const signature = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    console.log('Firma generada:', signature);

                    const paymentLink = `https://checkout.wompi.co/p/?public-key=${encodeURIComponent(publicKey)}&amount-in-cents=${amountInCents}¤cy=${encodeURIComponent(currency)}&reference=${encodeURIComponent(reference)}&redirect-url=${encodeURIComponent(redirectUrl)}&signature:integrity=${encodeURIComponent(signature)}`;
                    console.log('Enlace de pago generado:', paymentLink);

                    window.location.href = paymentLink;
                }).catch(error => {
                    console.error('Error al generar la firma:', error);
                    alert('Error al iniciar el pago. Intenta de nuevo.');
                });
            });
        });
    </script>
</body>
</html>
